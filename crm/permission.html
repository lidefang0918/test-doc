<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>【通用】数据权限 | ruoyi-vue-pro 开发指南</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .source-url {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        .content-wrapper {
            line-height: 1.8;
        }
        img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 20px 0;
        }
        pre {
            background: #f6f8fa;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
        }
        code {
            background: #f6f8fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>【通用】数据权限 | ruoyi-vue-pro 开发指南</h1>
        <div class="source-url">原始链接: <a href="https://doc.iocoder.cn/crm/permission/">https://doc.iocoder.cn/crm/permission/</a></div>
    </div>
    <div class="content-wrapper">
        <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">【通用】数据权限<!----></h1>  <div class="theme-vdoing-content content__default"><p>数据权限，由 <code>yudao-module-crm</code> 后端模块的 <code>permission</code> 包实现，支持某个人对某个数据（线索、客户、商机、合同等等），有对应的权限。</p> <p>目前权限由 CrmPermissionLevelEnum 枚举，包括 3 种：<code>OWNER</code>（负责人）、<code>WRITE</code>（读写）、<code>READ</code>（只读），并且 <code>OWNER &gt; WRITE &gt; READ</code>。</p> <div class="custom-block tip"><p class="custom-block-title">友情提示：</p> <p>为什么不使用全局封装的 [《数据权限》])(/data-permission) 呢？</p> <p>目前 CRM 系统的数据权限比较灵活，部分功能无法很好的支持。例如说：</p> <ul><li>全局的数据权限，只支持对某个数据的操作权限，而 CRM 需要分 OWNER、WRITE、READ 三种权限</li> <li>全局的数据全量，对关联数据的权限控制，无法很好的支持。例如说：对某个客户有 WRITE 权限时，可以 WRITE 它下面的联系人、商机、合同等等</li></ul> <p>你可以理解全局的数据权限是基于 DB（DAO）层面实现的，而 CRM 的数据权限是基于 Service 层面实现的。</p></div> <h2 id="_1-表结构"><a href="#_1-%E8%A1%A8%E7%BB%93%E6%9E%84" class="header-anchor">#</a> 1. 表结构</h2> <blockquote><p>省略 creator/create_time/updater/update_time/deleted/tenant_id 等通用字段</p></blockquote> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>crm_permission<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>

  <span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户编号'</span><span class="token punctuation">,</span>
  
  <span class="token identifier"><span class="token punctuation">`</span>biz_type<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'100'</span> <span class="token keyword">COMMENT</span> <span class="token string">'数据类型'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>biz_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'数据编号'</span><span class="token punctuation">,</span>
  
  <span class="token identifier"><span class="token punctuation">`</span>level<span class="token punctuation">`</span></span> <span class="token keyword">int</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'会员等级'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">86</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_unicode_ci <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'CRM 数据权限表'</span><span class="token punctuation">;</span>
</code></pre></div><p>基本就是三要素：</p> <ul><li>人：<code>user_id</code> 字段</li> <li>数据：<code>biz_type</code> + <code>biz_id</code> 字段。其中 <code>biz_type</code> 由 CrmBizTypeEnum 枚举，包括线索、客户、联系人、商机、合同、回款等等</li> <li>权限：<code>level</code> 字段。由 CrmPermissionLevelEnum 枚举，包括 <code>OWNER</code>、<code>WRITE</code>、<code>READ</code> 三种</li></ul> <h3 id="_1-1-owner-负责人"><a href="#_1-1-owner-%E8%B4%9F%E8%B4%A3%E4%BA%BA" class="header-anchor">#</a> 1.1 <code>OWNER</code> 负责人</h3> <p>① 每个数据在新增时，会插入一条 <code>OWNER</code> 的权限。例如说，新增一个客户，会插入一条 <code>OWNER</code> 的权限。如下图所示：</p> <p><img src="/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90%E6%96%B0%E5%A2%9E-%E8%B4%9F%E8%B4%A3%E4%BA%BA.png" alt="新增 OWNER 负责人（代码）"></p> <p>② 每个数据在转移时，会对新、老负责人的权限做不同的处理。例如说，联系人转移给其他人，会更新对应的权限。如下图所示：</p> <p><img src="/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90%E8%BD%AC%E7%A7%BB-%E8%B4%9F%E8%B4%A3%E4%BA%BA.png" alt="转移 OWNER 负责人（界面）"></p> <ul><li>老负责人，会将对应的 <code>crm_permission</code> 的 <code>level</code> 更新为 <code>READ</code></li> <li>新负责人，会插入一条 <code>OWNER</code> 的权限</li></ul> <p><img src="/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90%E8%BD%AC%E7%A7%BB-%E8%B4%9F%E8%B4%A3%E4%BA%BA2.png" alt="转移 OWNER 负责人（代码）"></p> <h3 id="_1-2-write-读写、read-只读"><a href="#_1-2-write-%E8%AF%BB%E5%86%99%E3%80%81read-%E5%8F%AA%E8%AF%BB" class="header-anchor">#</a> 1.2 <code>WRITE</code> 读写、<code>READ</code> 只读</h3> <p>在每个数据的详情界面，有一个 [团队成员] 的功能，可以查看当前数据的权限，同时可以修改 <code>WRITE</code> 和 <code>READ</code> 的权限。如下图所示：</p> <p><img src="/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90%E6%96%B0%E5%A2%9E-%E8%AF%BB%E5%86%99.png" alt="新增读写权限（界面）"></p> <p>这是一个通用的功能，不需要每个数据都实现一遍，在 CrmPermissionController 已经统一实现。如下图所示：</p> <p><img src="/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90%E6%96%B0%E5%A2%9E-%E8%AF%BB%E5%86%992.png" alt="新增读写权限（代码）"></p> <div class="custom-block tip"><p class="custom-block-title">友情提示：为什么转移负责人不能在 CrmPermissionController 统一实现呢？</p> <p>考虑到查询方便，每个数据记录自身会有 <code>owner_user_id</code> 字段，转移时需要更新，所以没一起实现。</p></div> <h2 id="_3-后端实现"><a href="#_3-%E5%90%8E%E7%AB%AF%E5%AE%9E%E7%8E%B0" class="header-anchor">#</a> 3. 后端实现</h2> <h3 id="_2-1-操作校验"><a href="#_2-1-%E6%93%8D%E4%BD%9C%E6%A0%A1%E9%AA%8C" class="header-anchor">#</a> 2.1 操作校验</h3> <p>操作校验，通过 <code>@CrmPermission</code> 注解实现，只要添加在 Service 方法上，即可实现对应的权限校验。</p> <p><img src="/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/CrmPermission%E6%B3%A8%E8%A7%A3.png" alt="CrmPermission 注解"></p> <p>① 使用示例，如下图所示：</p> <p><img src="/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/CrmPermission%E6%B3%A8%E8%A7%A3%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B.png" alt="CrmPermission 注解使用示例"></p> <p>② 通过 Spring AOP 实现，可见 CrmPermissionAspect 类，如下图所示：</p> <p><img src="/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/CrmPermissionAspect%E7%B1%BB.png" alt="CrmPermissionAspect 类"></p> <p>通过这个类，我们也可以看出为什么要有 <code>crm_permission</code> 表。如果没有这个表，我们需要查询每个业务的数据，通过它们的字段，判断当前用户是否有权限，这样拓展性比较差。</p> <p>③ 【CRM 管理员】的角色枚举是 <code>crm_admin</code>，它和全局的【超级管理员】 <code>super_admin</code> 是分开的。如下图所示：</p> <p><img src="/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/CRM%E7%AE%A1%E7%90%86%E5%91%98.png" alt="CRM 管理员"></p> <p>也就是说，把【CRM 管理员】分配给某个人时，可以查询和操作所有 CRM 的数据。</p> <h3 id="_2-2-查询过滤"><a href="#_2-2-%E6%9F%A5%E8%AF%A2%E8%BF%87%E6%BB%A4" class="header-anchor">#</a> 2.2 查询过滤</h3> <p>在数据的列表界面，我们需要在 DB 数据库查询的时候，就将没有 <code>READ</code> 权限的数据过滤掉。</p> <div class="custom-block tip"><p class="custom-block-title">疑问：为什么不通过类似 `@CrmPermission` 注解实现呢？</p> <p>可以实现，但是会查询特别多没权限的数据到内存中，导致性能比较差。</p></div> <p>这个无法通用实现，目前是每个业务 Mapper 拼接 SQL 实现，通过联表查询 <code>crm_permission</code> 表，进行过滤。如下图所示：</p> <p><img src="/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/%E6%9F%A5%E8%AF%A2%E8%BF%87%E6%BB%A4.png" alt="查询过滤"></p> <p>核心的拼接逻辑在 CrmPermissionUtils 的 <code>#appendPermissionCondition(...)</code> 方法里，不是很复杂，可以自己瞅瞅。如下图所示：</p> <p><img src="/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/CrmPermissionUtils%E7%B1%BB.png" alt="appendPermissionCondition 方法"></p> <p>另外，CRM 系统的所有管理界面，都有一个 CrmSceneTypeEnum 枚举，分成 3 种场景：<code>OWNER</code> 我负责的，<code>INVOLVED</code> 我参与的、<code>SUBORDINATE</code> 下属负责的，也是通过上面查询实现的。</p> <p><img src="/img/CRM%E6%89%8B%E5%86%8C/%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90/CRM%E5%9C%BA%E6%99%AF.png" alt="CRM 场景"></p> <div class="custom-block tip"><p class="custom-block-title">画外音</p> <p>看到这里，在回过头看为什么不基于全局的 [《数据权限》])(/data-permission) 实现，是不是有点明白了呢？</p> <p>在设计系统的数据权限，我们总是渴望通过全局的、自动化的方式实现。但是，实际上，业务的数据权限是非常复杂的，很难通过全局的方式实现。</p> <p>因此，我们需要在业务层面，实现对应的数据权限逻辑。嘿嘿~</p></div></div></div>
    </div>
</body>
</html>