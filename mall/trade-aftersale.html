<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>【交易】售后退款 | ruoyi-vue-pro 开发指南</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .source-url {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        .content-wrapper {
            line-height: 1.8;
        }
        img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 20px 0;
        }
        pre {
            background: #f6f8fa;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
        }
        code {
            background: #f6f8fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>【交易】售后退款 | ruoyi-vue-pro 开发指南</h1>
        <div class="source-url">原始链接: <a href="https://doc.iocoder.cn/mall/trade-aftersale/">https://doc.iocoder.cn/mall/trade-aftersale/</a></div>
    </div>
    <div class="content-wrapper">
        <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">【交易】售后退款<!----></h1>  <div class="theme-vdoing-content content__default"><h2 id="_1-表结构"><a href="#_1-%E8%A1%A8%E7%BB%93%E6%9E%84" class="header-anchor">#</a> 1. 表结构</h2> <p>售后退款，由 <code>yudao-module-trade</code> 后端模块的 <code>aftersale</code> 包实现，分成二个表：</p> <p><img src="/img/%E5%95%86%E5%9F%8E%E6%89%8B%E5%86%8C/%E5%94%AE%E5%90%8E%E9%80%80%E6%AC%BE/%E8%A1%A8%E5%85%B3%E7%B3%BB.png" alt="表关系"></p> <ul><li><code>trade_after_sale_</code>：售后订单表</li> <li><code>trade_after_sale_log</code>：售后订单日志表</li></ul> <h3 id="_1-1-售后订单表"><a href="#_1-1-%E5%94%AE%E5%90%8E%E8%AE%A2%E5%8D%95%E8%A1%A8" class="header-anchor">#</a> 1.1 售后订单表</h3> <blockquote><p>省略 creator/create_time/updater/update_time/deleted/tenant_id 等通用字段</p></blockquote> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>trade_after_sale<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'售后编号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>no<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_bin <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'售后单号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户编号'</span><span class="token punctuation">,</span>
  
  <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'售后类型'</span><span class="token punctuation">,</span>

  <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span> <span class="token keyword">int</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'售后状态'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>way<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'售后方式'</span><span class="token punctuation">,</span>
  
  <span class="token identifier"><span class="token punctuation">`</span>refund_price<span class="token punctuation">`</span></span> <span class="token keyword">int</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款金额，单位：分'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>apply_reason<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_bin <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'申请原因'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>apply_description<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'补充描述'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>apply_pic_urls<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'补充凭证图片'</span><span class="token punctuation">,</span>
  
  <span class="token identifier"><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单编号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>order_no<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_bin <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单流水号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>order_item_Id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单项编号'</span><span class="token punctuation">,</span>
  
  <span class="token identifier"><span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品 SPU 编号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>spu_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_bin <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品 SPU 名称'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品 SKU 编号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>properties<span class="token punctuation">`</span></span> json <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品属性数组，JSON 格式'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>pic_url<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品图片'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>count<span class="token punctuation">`</span></span> <span class="token keyword">int</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'购买数量'</span><span class="token punctuation">,</span>
  
  <span class="token identifier"><span class="token punctuation">`</span>audit_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'审批时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>audit_user_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">unsigned</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'审批人'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>audit_reason<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'审批备注'</span><span class="token punctuation">,</span>
  
  <span class="token identifier"><span class="token punctuation">`</span>logistics_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'退货物流公司编号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>logistics_no<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'退货物流单号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>delivery_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'退货时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>receive_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'收货时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>receive_reason<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'收货备注'</span><span class="token punctuation">,</span>
  
  <span class="token identifier"><span class="token punctuation">`</span>pay_refund_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">unsigned</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付退款编号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>refund_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款时间'</span><span class="token punctuation">,</span>

  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">23</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'售后订单'</span><span class="token punctuation">;</span>
</code></pre></div><p>字段还是非常多的，我们来分块来看看。</p> <p>① <code>no</code> 字段：售后单号，主要展示给用户看，由 TradeNoRedisDAO 的 <code>#generate(...)</code> 方法生成。</p> <p>而 <code>id</code> 字段是数据库自增的订单编号，系统内部使用，一般不展示给用户查看。</p> <p>② 【类型】<code>type</code> 字段：售后类型，由 AfterSaleTypeEnum 枚举，分成两种类型：</p> <ul><li>售中退款：交易完成【前】买家申请退款</li> <li>售后退款：交易完成【后】买家申请退款</li></ul> <p>③ 【状态】<code>status</code> 字段：订单状态，由 AfterSaleStatusEnum 枚举，流转状态如下图：</p> <p><img src="/img/%E5%95%86%E5%9F%8E%E6%89%8B%E5%86%8C/%E5%94%AE%E5%90%8E%E9%80%80%E6%AC%BE/%E5%94%AE%E5%90%8E%E7%8A%B6%E6%80%81%E6%B5%81%E8%BD%AC.png" alt="售后状态流转"></p> <p><code>way</code> 字段：售后方式，由 AfterSaleWayEnum 枚举，分成两种方式：仅退款、退货退款。如上图所示，退款会多 SELLER_AGREE、BUYER_DELIVERY 两个动作。</p> <p>④ 【申请】<code>refund_price</code>、<code>apply_reason</code>、<code>apply_description</code>、<code>apply_pic_urls</code> 字段：买家发起售后的基本信息。</p> <p>⑤ 【订单】<code>order_id</code>、<code>order_no</code>、<code>order_item_Id</code> 字段：关联的订单项信息，一个 <code>trade_order_item</code> 可以发起多次售后，同一时间只允许一个，并且最终只能有一个成功。</p> <p>如果你希望一个售后订单可以退多个订单项，需要自己加个 <code>trade_after_sale_item</code> 表，将部分【订单信息】【商品信息】挪过去。</p> <p>⑥ 【商品】<code>spu_id</code>、<code>sku_id</code>、<code>count</code> 字段：关联的商品信息。冗余的 <code>spu_name</code>、<code>pic_url</code>、<code>properties</code> 字段，是为了方便查询。</p> <p>⑦ 【审核】<code>audit_time</code>、<code>audit_user_id</code>、<code>audit_reason</code> 字段：卖家审核的信息。</p> <p>⑧ 【退货】<code>logistics_id</code>、<code>logistics_no</code>、<code>delivery_time</code> 字段：买家退货的信息。</p> <p><code>receive_time</code>、<code>receive_reason</code> 字段：卖家收货的信息。</p> <p>⑨ 【退款】<code>pay_refund_id</code>、<code>refund_time</code> 字段：退款的信息。 其中，<code>pay_refund_id</code> 关联的支付中心的退款单号。对支付中心还不了解的同学，可以阅读下 <a href="/pay/build/">《支付手册》</a> 文档。</p> <h3 id="_1-2-售后订单日志表"><a href="#_1-2-%E5%94%AE%E5%90%8E%E8%AE%A2%E5%8D%95%E6%97%A5%E5%BF%97%E8%A1%A8" class="header-anchor">#</a> 1.2 售后订单日志表</h3> <blockquote><p>省略 creator/create_time/updater/update_time/deleted/tenant_id 等通用字段</p></blockquote> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>trade_after_sale_log<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户编号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>user_type<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户类型'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>after_sale_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'售后编号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>before_status<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'售后状态（之前）'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>after_status<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'售后状态（之后）'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>operate_type<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'操作类型'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>content<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_bin <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'操作明细'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">32</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'售后订单日志'</span><span class="token punctuation">;</span>
</code></pre></div><p>每次售后状态变更，都会记录一条日志，方便后续查询、统计。</p> <p>通过 <code>@AfterSaleLog</code> 注解，基于 Spring AOP 实现记录，具体可以看看 AfterSaleLogAspect 类。</p> <h2 id="_2-售后流程"><a href="#_2-%E5%94%AE%E5%90%8E%E6%B5%81%E7%A8%8B" class="header-anchor">#</a> 2. 售后流程</h2> <p>本小节，我们按照售后的 <code>申请 =&gt; 审批 =&gt; 退货 =&gt; 收货 =&gt; 退款</code> 流程，来看看售后的各个阶段。</p> <p><img src="/img/%E5%95%86%E5%9F%8E%E6%89%8B%E5%86%8C/%E5%94%AE%E5%90%8E%E9%80%80%E6%AC%BE/%E5%94%AE%E5%90%8E%E6%B5%81%E7%A8%8B.png" alt="售后流程"></p> <p><img src="/img/%E5%95%86%E5%9F%8E%E6%89%8B%E5%86%8C/%E5%94%AE%E5%90%8E%E9%80%80%E6%AC%BE/%E5%94%AE%E5%90%8E%E6%B5%81%E7%A8%8B-%E5%8E%BB%E5%94%AE%E5%90%8E.png" alt="去售后"></p> <h3 id="_2-1-申请【买家】"><a href="#_2-1-%E7%94%B3%E8%AF%B7%E3%80%90%E4%B9%B0%E5%AE%B6%E3%80%91" class="header-anchor">#</a> 2.1 申请【买家】</h3> <p>① 点击「申请售后」按钮，进入售后页面，对应前端 <code>yudao-mall-uniapp</code> 项目的 <code>pages/order/aftersale/apply.vue</code> 页面，如下图所示：</p> <p><img src="/img/%E5%95%86%E5%9F%8E%E6%89%8B%E5%86%8C/%E5%94%AE%E5%90%8E%E9%80%80%E6%AC%BE/%E7%94%B3%E8%AF%B7-%E7%A7%BB%E5%8A%A8%E7%AB%AF.png" alt="售后申请"></p> <p>另外，可选的“申请原因”，可在 <code>trade_config</code> 表的 <code>after_sale_refund_reasons</code>、<code>after_sale_return_reasons</code> 字段配置。</p> <p>② 点击「提交」按钮，调用后端对应 AppAfterSaleController 的 <code>#createAfterSale(...)</code> 提供的“申请售后”接口，插入 <code>trade_after_sale</code> 表一条记录，状态为 <code>APPLY</code> 申请中。</p> <div class="custom-block tip"><p class="custom-block-title">售后状态：APPLY 申请中</p></div> <p>③ 发起成功后，进入售后列表页面，对应前端 <code>yudao-mall-uniapp</code> 项目的 <code>pages/order/aftersale/list.vue</code> 页面，如下图所示：</p> <p><img src="/img/%E5%95%86%E5%9F%8E%E6%89%8B%E5%86%8C/%E5%94%AE%E5%90%8E%E9%80%80%E6%AC%BE/%E5%94%AE%E5%90%8E%E6%B5%81%E7%A8%8B-%E5%94%AE%E5%90%8E%E5%88%97%E8%A1%A8.png" alt="售后列表"></p> <p>④ 点击第一条售后记录，进入售后详情页面，对应前端 <code>yudao-mall-uniapp</code> 项目的 <code>pages/order/aftersale/detail.vue</code> 页面，如下图所示：</p> <p><img src="/img/%E5%95%86%E5%9F%8E%E6%89%8B%E5%86%8C/%E5%94%AE%E5%90%8E%E9%80%80%E6%AC%BE/%E5%94%AE%E5%90%8E%E6%B5%81%E7%A8%8B-%E5%94%AE%E5%90%8E%E8%AF%A6%E6%83%85.png" alt="售后详情"></p> <p>此时，买家只能等待卖家审核，或者取消售后。</p> <h3 id="_2-2-审批【卖家】"><a href="#_2-2-%E5%AE%A1%E6%89%B9%E3%80%90%E5%8D%96%E5%AE%B6%E3%80%91" class="header-anchor">#</a> 2.2 审批【卖家】</h3> <p>① 卖家可以在售后列表进行审批，对应 [商城系统 -&gt; 订单中心 -&gt; 售后退款] 菜单，对应 <code>yudao-ui-admin-vue3</code> 项目的 <code>@/views/trade/afterSale</code> 目录。如下图所示：</p> <p><img src="/img/%E5%95%86%E5%9F%8E%E6%89%8B%E5%86%8C/%E5%94%AE%E5%90%8E%E9%80%80%E6%AC%BE/%E5%AE%A1%E6%89%B9-%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0-%E5%88%97%E8%A1%A8.png" alt="售后列表"></p> <p>② 点击第一条售后记录的「处理退款」按钮，进入售后详情页面，对应 <code>yudao-ui-admin-vue3</code> 项目的 <code>@/views/trade/afterSale/detail</code> 目录，如下图所示：</p> <p><img src="/img/%E5%95%86%E5%9F%8E%E6%89%8B%E5%86%8C/%E5%94%AE%E5%90%8E%E9%80%80%E6%AC%BE/%E5%AE%A1%E6%89%B9-%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0-%E5%88%97%E8%A1%A8.png" alt="售后详情"></p> <p>③ 点击「同意售后」按钮，调用后端对应 AfterSaleController 的 <code>#agreeAfterSale(...)</code> 提供的“同意售后”接口，更新 <code>trade_after_sale</code> 表的状态为 <code>SELLER_AGREE</code> 卖家通过（待买家退货）。</p> <div class="custom-block tip"><p class="custom-block-title">售后状态：SELLER_AGREE 卖家通过（待买家退货）</p></div> <h3 id="_2-3-退货【买家】"><a href="#_2-3-%E9%80%80%E8%B4%A7%E3%80%90%E4%B9%B0%E5%AE%B6%E3%80%91" class="header-anchor">#</a> 2.3 退货【买家】</h3> <p>① 点击「填写退货」按钮，进入退货页面，对应前端 <code>yudao-mall-uniapp</code> 项目的 <code>pages/order/aftersale/return-delivery.vue</code> 页面，如下图所示：</p> <p><img src="/img/%E5%95%86%E5%9F%8E%E6%89%8B%E5%86%8C/%E5%94%AE%E5%90%8E%E9%80%80%E6%AC%BE/%E9%80%80%E8%B4%A7-%E7%A7%BB%E5%8A%A8%E7%AB%AF.png" alt="退货"></p> <p>② 点击「提交」按钮，调用后端对应 AppAfterSaleController 的 <code>#deliveryAfterSale(...)</code> 提供的“退回货物”接口，更新 <code>trade_after_sale</code> 表的状态为 <code>BUYER_DELIVERY</code> 买家已退货（待卖家收货）。</p> <div class="custom-block tip"><p class="custom-block-title">售后状态：BUYER_DELIVERY 买家已退货（待卖家收货）</p></div> <h3 id="_2-4-收货【卖家】"><a href="#_2-4-%E6%94%B6%E8%B4%A7%E3%80%90%E5%8D%96%E5%AE%B6%E3%80%91" class="header-anchor">#</a> 2.4 收货【卖家】</h3> <p>点击「确认收货」按钮，调用后端对应 AfterSaleController 的 <code>#receiveAfterSale(...)</code> 提供的“确认收货”接口，更新 <code>trade_after_sale</code> 表的状态为 <code>WAIT_REFUND</code> 卖家已收货（待卖家退款）。</p> <div class="custom-block tip"><p class="custom-block-title">售后状态：WAIT_REFUND 卖家已收货（待卖家退款）</p></div> <p><img src="/img/%E5%95%86%E5%9F%8E%E6%89%8B%E5%86%8C/%E5%94%AE%E5%90%8E%E9%80%80%E6%AC%BE/%E6%94%B6%E8%B4%A7-%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0.png" alt="收货"></p> <h3 id="_2-5-退款【卖家】"><a href="#_2-5-%E9%80%80%E6%AC%BE%E3%80%90%E5%8D%96%E5%AE%B6%E3%80%91" class="header-anchor">#</a> 2.5 退款【卖家】</h3> <p>① 点击「确认退款」按钮，调用后端对应 AfterSaleController 的 <code>#refundAfterSale(...)</code> 提供的“确认退款”接口，更新 <code>trade_after_sale</code> 表的状态为 <code>COMPLETE</code> 退款成功。</p> <div class="custom-block tip"><p class="custom-block-title">售后状态：COMPLETE 退款成功</p></div> <p><img src="/img/%E5%95%86%E5%9F%8E%E6%89%8B%E5%86%8C/%E5%94%AE%E5%90%8E%E9%80%80%E6%AC%BE/%E9%80%80%E6%AC%BE-%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0.png" alt="退款"></p> <p>该接口的内部实现，主要是调用支付中心的退款接口，具体可以看看 <a href="/pay/refund-demo/">《21.支付宝、微信退款接入》</a> 文档。</p> <p>② 在真正退款到卖家的支付宝、微信账户后（退款是个异步过程），支付中心会回调 AfterSaleController 的 <code>#updateAfterRefund(...)</code> 提供的“更新售后订单为已退款”接口，目前仅仅打印日志，可以按需拓展。</p> <p>至此，售后流程结束~可以试着多多 debug 调试整个流程，并不复杂噢。</p> <h2 id="_3-售后配置"><a href="#_3-%E5%94%AE%E5%90%8E%E9%85%8D%E7%BD%AE" class="header-anchor">#</a> 3. 售后配置</h2> <p><img src="/img/%E5%95%86%E5%9F%8E%E6%89%8B%E5%86%8C/%E5%94%AE%E5%90%8E%E9%80%80%E6%AC%BE/%E5%94%AE%E5%90%8E%E9%85%8D%E7%BD%AE.png" alt="售后配置"></p> <ul><li>SQL 对应 <code>trade_config</code> 表的 <code>after_sale_</code> 开头的字段。</li> <li>前端对应 <code>yudao-ui-admin-vue3</code> 项目的 <code>views/mall/trade/config/index.vue</code> 目录</li> <li>后端对应 <code>yudao-module-trade</code> 项目的 TradeConfigController 类</li></ul></div></div>
    </div>
</body>
</html>