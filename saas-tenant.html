<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS 多租户【字段隔离】 | ruoyi-vue-pro 开发指南</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .source-url {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        .content-wrapper {
            line-height: 1.8;
        }
        img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 20px 0;
        }
        pre {
            background: #f6f8fa;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
        }
        code {
            background: #f6f8fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>SaaS 多租户【字段隔离】 | ruoyi-vue-pro 开发指南</h1>
        <div class="source-url">原始链接: <a href="https://doc.iocoder.cn/saas-tenant/">https://doc.iocoder.cn/saas-tenant/</a></div>
    </div>
    <div class="content-wrapper">
        <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">SaaS 多租户【字段隔离】<!----></h1>  <div class="theme-vdoing-content content__default"><p>本章节，将介绍多租户的基础知识、以及怎样使用多租户的功能。</p> <p>相关的视频教程：</p> <ul><li><a href="https://t.zsxq.com/06ufyFAeM" target="_blank" rel="noopener noreferrer">01、如何实现多租户的 DB 封装？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://t.zsxq.com/067eQfAQN" target="_blank" rel="noopener noreferrer">02、如何实现多租户的 Redis 封装？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://t.zsxq.com/06Nnm6QBE" target="_blank" rel="noopener noreferrer">03、如何实现多租户的 Web 与 Security 封装？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://t.zsxq.com/06AYJUR3V" target="_blank" rel="noopener noreferrer">04、如何实现多租户的 Job 封装？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://t.zsxq.com/06aq3nuNF" target="_blank" rel="noopener noreferrer">05、如何实现多租户的 MQ 与 Async 封装？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://t.zsxq.com/06vFQVJIe" target="_blank" rel="noopener noreferrer">06、如何实现多租户的 AOP 与 Util 封装？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://t.zsxq.com/063bqRrNZ" target="_blank" rel="noopener noreferrer">07、如何实现多租户的管理？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://t.zsxq.com/06rBI66yV" target="_blank" rel="noopener noreferrer">08、如何实现多租户的套餐？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="_1-多租户是什么"><a href="#_1-%E5%A4%9A%E7%A7%9F%E6%88%B7%E6%98%AF%E4%BB%80%E4%B9%88" class="header-anchor">#</a> 1. 多租户是什么？</h2> <p>多租户，简单来说是指<strong>一个</strong>业务系统，可以为<strong>多个</strong>组织服务，并且组织之间的数据是<strong>隔离</strong>的。</p> <p>例如说，在服务上部署了一个 <a href="https://github.com/YunaiV/ruoyi-vue-pro" target="_blank" rel="noopener noreferrer"><code>ruoyi-vue-pro</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 系统，可以支持多个不同的公司使用。这里的<strong>一个公司就是一个租户</strong>，每个用户必然属于某个租户。因此，用户也只能看见自己租户下面的内容，其它租户的内容对他是不可见的。</p> <h2 id="_2-数据隔离方案"><a href="#_2-%E6%95%B0%E6%8D%AE%E9%9A%94%E7%A6%BB%E6%96%B9%E6%A1%88" class="header-anchor">#</a> 2. 数据隔离方案</h2> <p>多租户的数据隔离方案，可以分成分成三种：</p> <ol><li>DATASOURCE 模式：独立数据库</li> <li>SCHEMA 模式：共享数据库，独立 Schema</li> <li>COLUMN 模式：共享数据库，共享 Schema，共享数据表</li></ol> <h3 id="_2-1-datasource-模式"><a href="#_2-1-datasource-%E6%A8%A1%E5%BC%8F" class="header-anchor">#</a> 2.1 DATASOURCE 模式</h3> <p>一个租户一个数据库，这种方案的用户数据隔离级别最高，安全性最好，但成本也高。</p> <p><img src="/img/Saas%E5%A4%9A%E7%A7%9F%E6%88%B7/DATASOURCE%E6%A8%A1%E5%BC%8F.png" alt="DATASOURCE 模式"></p> <ul><li>优点：为不同的租户提供独立的数据库，有助于简化数据模型的扩展设计，满足不同租户的独特需求；如果出现故障，恢复数据比较简单。</li> <li>缺点：增大了数据库的安装数量，随之带来维护成本和购置成本的增加。</li></ul> <h3 id="_2-2-schema-模式"><a href="#_2-2-schema-%E6%A8%A1%E5%BC%8F" class="header-anchor">#</a> 2.2 SCHEMA 模式</h3> <p>多个或所有租户共享数据库，但一个租户一个表。</p> <p><img src="/img/Saas%E5%A4%9A%E7%A7%9F%E6%88%B7/SCHEMA%E6%A8%A1%E5%BC%8F.png" alt="SCHEMA 模式"></p> <ul><li>优点：为安全性要求较高的租户提供了一定程度的逻辑数据隔离，并不是完全隔离；每个数据库可以支持更多的租户数量。</li> <li>缺点：如果出现故障，数据恢复比较困难，因为恢复数据库将牵扯到其他租户的数据； 如果需要跨租户统计数据，存在一定困难。</li></ul> <h3 id="_2-3-column-模式"><a href="#_2-3-column-%E6%A8%A1%E5%BC%8F" class="header-anchor">#</a> 2.3 COLUMN 模式</h3> <p>共享数据库，共享数据架构。租户共享同一个数据库、同一个表，但在表中通过 <code>tenant_id</code> 字段区分租户的数据。这是共享程度最高、隔离级别最低的模式。</p> <p><img src="/img/Saas%E5%A4%9A%E7%A7%9F%E6%88%B7/COLUMN%E6%A8%A1%E5%BC%8F.png" alt="COLUMN 模式"></p> <ul><li>优点：维护和购置成本最低，允许每个数据库支持的租户数量最多。</li> <li>缺点：隔离级别最低，安全性最低，需要在设计开发时加大对安全的开发量；数据备份和恢复最困难，需要逐表逐条备份和还原。</li></ul> <h3 id="_2-4-方案选择"><a href="#_2-4-%E6%96%B9%E6%A1%88%E9%80%89%E6%8B%A9" class="header-anchor">#</a> 2.4 方案选择</h3> <p><img src="/img/Saas%E5%A4%9A%E7%A7%9F%E6%88%B7/%E6%A8%A1%E5%BC%8F%E9%80%89%E6%8B%A9.png" alt="模式选择"></p> <ul><li>一般情况下，可以考虑采用 COLUMN 模式，开发、运维简单，以最少的服务器为最多的租户提供服务。</li> <li>租户规模比较大，或者一些租户对安全性要求较高，可以考虑采用 DATASOURCE 模式，当然它也相对复杂的多。</li> <li>不推荐采用 SCHEMA 模式，因为它的优点并不明显，而且它的缺点也很明显，同时对复杂 SQL 支持一般。</li></ul> <div class="custom-block tip"><p class="custom-block-title">提问：项目支持哪些模式？</p> <p>目前支持最主流的 DATASOURCE 和 COLUMN 两种模式。而 SCHEMA 模式不推荐使用，所以暂时不考虑实现。</p></div> <p>考虑到让大家更好的理解 DATASOURCE 和 COLUMN 模式，拆成了两篇文章：</p> <ul><li><a href="/saas-tenant">《SaaS 多租户【字段隔离】》</a>：讲解 COLUMN 模式</li> <li><a href="/saas-tenant/dynamic">《SaaS 多租户【数据库隔离】》</a>：讲解 DATASOURCE 模式</li></ul> <h2 id="_3-多租户的开关"><a href="#_3-%E5%A4%9A%E7%A7%9F%E6%88%B7%E7%9A%84%E5%BC%80%E5%85%B3" class="header-anchor">#</a> 3. 多租户的开关</h2> <p>系统有两个配置项，设置为 <code>true</code> 时开启多租户，设置为 <code>false</code> 时关闭多租户。</p> <p>注意，两者需要保持一致，否则会报错！</p> <table><thead><tr><th>配置项</th> <th>说明</th> <th>配置文件</th></tr></thead> <tbody><tr><td><code>yudao.server.tenant</code></td> <td>后端开关</td> <td><img src="/img/Saas%E5%A4%9A%E7%A7%9F%E6%88%B7/01.png" alt="示例"></td></tr> <tr><td><code>VUE_APP_TENANT_ENABLE</code></td> <td>前端开关</td> <td><img src="/img/Saas%E5%A4%9A%E7%A7%9F%E6%88%B7/02.png" alt="示例"></td></tr></tbody></table> <div class="custom-block tip"><p class="custom-block-title">疑问：为什么要设置两个配置项？</p> <p>前端登录界面需要使用到多租户的配置项，从后端加载配置项的话，体验会比较差。</p></div> <h2 id="_4-多租户的业务功能"><a href="#_4-%E5%A4%9A%E7%A7%9F%E6%88%B7%E7%9A%84%E4%B8%9A%E5%8A%A1%E5%8A%9F%E8%83%BD" class="header-anchor">#</a> 4. 多租户的业务功能</h2> <p>多租户主要有两个业务功能：</p> <table><thead><tr><th>业务功能</th> <th>说明</th> <th>界面</th> <th>代码</th></tr></thead> <tbody><tr><td>租户管理</td> <td>配置系统租户，创建对应的租户管理员</td> <td><img src="/img/Saas%E5%A4%9A%E7%A7%9F%E6%88%B7/03.png" alt="租户管理"></td> <td><a href="https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-system/src/main/java/cn/iocoder/yudao/module/system/service/tenant/TenantServiceImpl.java" target="_blank" rel="noopener noreferrer">后端<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://github.com/yudaocode/yudao-ui-admin-vue2/blob/master/src/views/system/tenant/index.vue" target="_blank" rel="noopener noreferrer">前端<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td>租户套餐</td> <td>配置租户套餐，自定每个租户的菜单、操作、按钮的权限</td> <td><img src="/img/Saas%E5%A4%9A%E7%A7%9F%E6%88%B7/04.png" alt="租户套餐"></td> <td><a href="https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-system/src/main/java/cn/iocoder/yudao/module/system/service/tenant/TenantPackageServiceImpl.java" target="_blank" rel="noopener noreferrer">后端<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://github.com/yudaocode/yudao-ui-admin-vue2/blob/master/src/views/system/tenantPackage/index.vue" target="_blank" rel="noopener noreferrer">前端<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr></tbody></table> <p><strong>下面，我们来新增一个租户，它使用 COLUMN 模式。</strong></p> <p>① 点击 [租户管理] 菜单，点击 [新增] 按钮，填写租户的信息。</p> <p><img src="/img/Saas%E5%A4%9A%E7%A7%9F%E6%88%B7/05.png" alt="新增租户"></p> <p>② 点击 [确认] 按钮，完成租户的创建，它会自动创建对应的租户管理员、角色等信息。</p> <p><img src="/img/Saas%E5%A4%9A%E7%A7%9F%E6%88%B7/06.png" alt="租户的管理员、角色"></p> <p>③ 退出系统，登录刚创建的租户。</p> <p><img src="/img/Saas%E5%A4%9A%E7%A7%9F%E6%88%B7/07.png" alt="登录界面"></p> <p>至此，我们已经完成了租户的创建。</p> <h2 id="_5-多租户的技术组件"><a href="#_5-%E5%A4%9A%E7%A7%9F%E6%88%B7%E7%9A%84%E6%8A%80%E6%9C%AF%E7%BB%84%E4%BB%B6" class="header-anchor">#</a> 5. 多租户的技术组件</h2> <p>技术组件 <a href="https://github.com/YunaiV/ruoyi-vue-pro/tree/master/yudao-framework/yudao-spring-boot-starter-biz-tenant/" target="_blank" rel="noopener noreferrer"><code>yudao-spring-boot-starter-biz-tenant</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，实现透明化的多租户能力，针对 Web、Security、DB、Redis、AOP、Job、MQ、Async 等多个层面进行封装。</p> <h3 id="_5-1-租户上下文"><a href="#_5-1-%E7%A7%9F%E6%88%B7%E4%B8%8A%E4%B8%8B%E6%96%87" class="header-anchor">#</a> 5.1 租户上下文</h3> <p><a href="https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-biz-tenant/src/main/java/cn/iocoder/yudao/framework/tenant/core/context/TenantContextHolder.java" target="_blank" rel="noopener noreferrer">TenantContextHolder<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是租户上下文，通过 ThreadLocal 实现租户编号的共享与传递。</p> <p>通过调用 TenantContextHolder 的 <code>#getTenantId()</code> <strong>静态</strong>方法，获得当前的租户编号。绝绝绝大多数情况下，并不需要。</p> <h3 id="_5-2-web-层【重要】"><a href="#_5-2-web-%E5%B1%82%E3%80%90%E9%87%8D%E8%A6%81%E3%80%91" class="header-anchor">#</a> 5.2 Web 层【重要】</h3> <blockquote><p>实现可见 <a href="https://github.com/YunaiV/ruoyi-vue-pro/tree/master/yudao-framework/yudao-spring-boot-starter-biz-tenant/src/main/java/cn/iocoder/yudao/framework/tenant/core/web" target="_blank" rel="noopener noreferrer"><code>web</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 包。</p></blockquote> <p>默认情况下，前端的每个请求 Header <strong>必须</strong>带上 <code>tenant-id</code>，值为租户编号，即 <code>system_tenant</code> 表的主键编号。</p> <p><img src="/img/Saas%E5%A4%9A%E7%A7%9F%E6%88%B7/08.png" alt="请求示例"></p> <p>如果不带该请求头，会报“租户的请求未传递，请进行排查”错误提示。</p> <p>😜 方式一：通过 <code>yudao.tenant.ignore-urls</code> 配置项，可以设置哪些 URL 无需带该请求头。例如说：</p> <p><img src="/img/Saas%E5%A4%9A%E7%A7%9F%E6%88%B7/09.png" alt=" 配置项"></p> <p>😆 方式二：【推荐】在 Controller 方法上，使用 <code>@TenantIgnore</code> 注解，忽略该方法的租户校验。例如说：</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// TenantController.java</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/get-id-by-name"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@TenantIgnore</span> <span class="token comment">// &lt;--- 重要！！！</span>
<span class="token keyword">public</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">getTenantIdByName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_5-3-security-层"><a href="#_5-3-security-%E5%B1%82" class="header-anchor">#</a> 5.3 Security 层</h3> <blockquote><p>实现可见 <a href="https://github.com/YunaiV/ruoyi-vue-pro/tree/master/yudao-framework/yudao-spring-boot-starter-biz-tenant/src/main/java/cn/iocoder/yudao/framework/tenant/core/security" target="_blank" rel="noopener noreferrer"><code>security</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 包。</p></blockquote> <p>主要是校验登录的用户，校验是否有权限访问该租户，避免越权问题。</p> <h3 id="_5-4-db-层【重要】"><a href="#_5-4-db-%E5%B1%82%E3%80%90%E9%87%8D%E8%A6%81%E3%80%91" class="header-anchor">#</a> 5.4 DB 层【重要】</h3> <blockquote><p>实现可见 <a href="https://github.com/YunaiV/ruoyi-vue-pro/tree/master/yudao-framework/yudao-spring-boot-starter-biz-tenant/src/main/java/cn/iocoder/yudao/framework/tenant/core/db" target="_blank" rel="noopener noreferrer"><code>db</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 包。</p></blockquote> <p>COLUMN 模式，基于 MyBatis Plus 自带的<a href="https://baomidou.com/plugins/tenant/" target="_blank" rel="noopener noreferrer">多租户<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>功能实现。</p> <p>核心：每次对数据库操作时，它会<strong>自动</strong>拼接 <code>WHERE tenant_id = ?</code> 条件来进行租户的过滤，并且基本支持所有的 SQL 场景。</p> <p>如下是具体方式：</p> <p>① <strong>需要</strong>开启多租户的表，必须添加 <code>tenant_id</code> 字段。例如说 <code>system_users</code>、<code>system_role</code> 等表。</p> <div class="language-SQL extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>system_role<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
   <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'角色ID'</span><span class="token punctuation">,</span>
   <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'角色名称'</span><span class="token punctuation">,</span>
   <span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'租户编号'</span><span class="token punctuation">,</span>
   <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'角色信息表'</span><span class="token punctuation">;</span>
</code></pre></div><p>并且该表对应的 DO 需要使用到 <code>tenantId</code> 属性时，建议继承 <a href="https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-biz-tenant/src/main/java/cn/iocoder/yudao/framework/tenant/core/db/TenantBaseDO.java" target="_blank" rel="noopener noreferrer">TenantBaseDO<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 类。</p> <p>② <strong>无需</strong>开启多租户的表，需要添加表名到 <code>yudao.tenant.ignore-tables</code> 配置项目。例如说：</p> <p><img src="/img/Saas%E5%A4%9A%E7%A7%9F%E6%88%B7/10.png" alt=" 配置项"></p> <p>如果不配置的话，MyBatis Plus 会自动拼接 <code>WHERE tenant_id = ?</code> 条件，导致报 <code>tenant_id</code> 字段不存在的错误。</p> <div class="custom-block tip"><p class="custom-block-title">友情提示：MyBatis Plus 的多租户方案，在我们在 MyBatis XML 手写 SQL 时，是不生效的，即不会拼接 `tenant_id` 字段！！！</p> <p>解决方案：需要手动自己拼接，可见 <code>ErpPurchaseStatisticsMapper.xml</code> 案例，如下所示：</p> <div class="language-SQL extra-class"><pre class="language-sql"><code>tenant_id <span class="token operator">=</span> ${<span class="token variable">@cn.iocoder.yudao.framework.tenant.core.context.TenantContextHolder</span><span class="token variable">@getRequiredTenantId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>}
</code></pre></div><ul><li>其中，后面 <code>${@...}</code> 一串，是 MyBatis 调用静态方法的方式，即使用 TenantContextHolder 的 <code>#getRequiredTenantId()</code> 方法，获得当前的租户编号。</li></ul> <p>补充说明：后续和球友沟通下来，部分简单 SQL 情况下，MyBatis Plus 还是会拼接。可见 <a href="https://t.zsxq.com/O8ys4" target="_blank" rel="noopener noreferrer">https://t.zsxq.com/O8ys4<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 帖子，欢迎讨论！</p></div> <p>③ 另外，<strong>无需</strong>开启多租户的表，也可以通过在 DO 实体类上，添加 <code>@TenantIgnore</code> 注解，忽略该表的租户过滤。例如说：</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span><span class="token string">"system_dict_data"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@TenantIgnore</span> <span class="token comment">// &lt;--- 重要！！！</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DictDataDO</span> <span class="token keyword">extends</span> <span class="token class-name">BaseDO</span> <span class="token punctuation">{</span>
    
    <span class="token comment">// ... 省略属性</span>
    
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_5-5-redis-层【重要】"><a href="#_5-5-redis-%E5%B1%82%E3%80%90%E9%87%8D%E8%A6%81%E3%80%91" class="header-anchor">#</a> 5.5 Redis 层【重要】</h3> <blockquote><p>实现可见 <a href="https://github.com/YunaiV/ruoyi-vue-pro/tree/master/yudao-framework/yudao-spring-boot-starter-biz-tenant/src/main/java/cn/iocoder/yudao/framework/tenant/core/redis" target="_blank" rel="noopener noreferrer"><code>redis</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 包。</p></blockquote> <p>由于 Redis 不同于 DB 有 <code>tenant_id</code> 字段，无法通过类似 <code>WHERE tenant_id</code> = ? 的方式过滤，所以需要通过在 Redis Key 上增加 <code>:t{tenantId}</code> 后缀的方式，进行租户之间的隔离。</p> <p>例如说，假设 Redis Key 是 <code>user:%d</code>，示例是 <code>user:1024</code>；对应到多租户 1 的 Redis Key 是 <code>user:t1:1024</code>。</p> <div class="custom-block tip"><p class="custom-block-title">为什么 Redis Key 要多租户隔离呢？</p> <ul><li>① 在使用 DATASOURCE 模式时，不同库的相同表的 id 可能相同，例如说 A 库的用户，和 B 库的用户都是 1024，直接缓存会存在 Redis Key 的冲突。</li> <li>② 在所有模式下，跨租户可能存在相同的需要唯一的数据，例如说用户的手机号，直接缓存会存在 Redis Key 的冲突。</li></ul></div> <h4 id="使用方式一-基于-spring-cache-redis【推荐】"><a href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F%E4%B8%80-%E5%9F%BA%E4%BA%8E-spring-cache-redis%E3%80%90%E6%8E%A8%E8%8D%90%E3%80%91" class="header-anchor">#</a> 使用方式一：基于 Spring Cache + Redis【推荐】</h4> <p>只需要一步，在方法上添加 Spring Cache 注解，例如说 <code>@Cachable</code>、<code>@CachePut</code>、<code>@CacheEvict</code>。</p> <p>具体的实现原理，可见 <a href="https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-biz-tenant/src/main/java/cn/iocoder/yudao/framework/tenant/core/redis/TenantRedisCacheManager.java" target="_blank" rel="noopener noreferrer">TenantRedisCacheManager<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的源码。</p> <p>注意！！！默认配置下，Spring Cache 都开启 Redis Key 的多租户隔离。如果不需要，可以将 Key 添加到 <code>yudao.tenant.ignore-caches</code> 配置项中。如下图所示：</p> <p><img src="/img/Saas%E5%A4%9A%E7%A7%9F%E6%88%B7/%E5%BF%BD%E7%95%A5%E5%A4%9A%E7%A7%9F%E6%88%B7RedisKey.png" alt=" 配置项"></p> <h4 id="使用方式二-基于-redistemplate-tenantrediskeydefine"><a href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F%E4%BA%8C-%E5%9F%BA%E4%BA%8E-redistemplate-tenantrediskeydefine" class="header-anchor">#</a> 使用方式二：基于 RedisTemplate + TenantRedisKeyDefine</h4> <p>暂时没有合适的封装，需要在自己 format Redis Key 的时候，手动将 <code>:t{tenantId}</code> 后缀拼接上。</p> <p>这也是为什么，我推荐你使用 Spring Cache + Redis 的原因！</p> <h3 id="_5-6-aop【重要】"><a href="#_5-6-aop%E3%80%90%E9%87%8D%E8%A6%81%E3%80%91" class="header-anchor">#</a> 5.6 AOP【重要】</h3> <blockquote><p>实现可见 <a href="https://github.com/YunaiV/ruoyi-vue-pro/tree/master/yudao-framework/yudao-spring-boot-starter-biz-tenant/src/main/java/cn/iocoder/yudao/framework/tenant/core/aop" target="_blank" rel="noopener noreferrer"><code>aop</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 包。</p></blockquote> <p>① 声明 <a href="https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-biz-tenant/src/main/java/cn/iocoder/yudao/framework/tenant/core/aop/TenantIgnore.java" target="_blank" rel="noopener noreferrer"><code>@TenantIgnore</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 注解在方法上，标记指定方法不进行租户的自动过滤，避免<strong>自动</strong>拼接 <code>WHERE tenant_id = ?</code> 条件等等。</p> <p>例如说：<a href="https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-system/src/main/java/cn/iocoder/yudao/module/system/service/permission/RoleServiceImpl.java" target="_blank" rel="noopener noreferrer">RoleServiceImpl<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的 <a href="https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-system/src/main/java/cn/iocoder/yudao/module/system/service/permission/RoleServiceImpl.java#L83-L100" target="_blank" rel="noopener noreferrer"><code>#initLocalCache()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 方法，加载<strong>所有</strong>租户的角色到内存进行缓存，如果不声明 <code>@TenantIgnore</code> 注解，会导致租户的自动过滤，只加载了某个租户的角色。</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token comment">// RoleServiceImpl.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoleServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">RoleService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token annotation punctuation">@Lazy</span> <span class="token comment">// 注入自己，所以延迟加载</span>
    <span class="token keyword">private</span> <span class="token class-name">RoleService</span> self<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token annotation punctuation">@TenantIgnore</span> <span class="token comment">// 忽略自动多租户，全局初始化缓存</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... 从数据库中，加载角色</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>fixedDelay <span class="token operator">=</span> <span class="token constant">SCHEDULER_PERIOD</span><span class="token punctuation">,</span> initialDelay <span class="token operator">=</span> <span class="token constant">SCHEDULER_PERIOD</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">schedulePeriodicRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span><span class="token function">initLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;x&gt; 通过 self 引用到 Spring 代理对象</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>有一点要格外注意，由于 <code>@TenantIgnore</code> 注解是基于 Spring AOP 实现，如果是<strong>方法内部的调用</strong>，避免使用 <code>this</code> 导致不生效，可以采用上述示例的 <code>&lt;x&gt;</code> 处的 <code>self</code> 方式。</p> <p>② 使用 <a href="https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-biz-tenant/src/main/java/cn/iocoder/yudao/framework/tenant/core/util/TenantUtils.java" target="_blank" rel="noopener noreferrer">TenantUtils<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的 <code>#execute(Long tenantId, Runnable runnable)</code> 方法，模拟指定租户( <code>tenantId</code> )，执行某段业务逻辑( <code>runnable</code> )。</p> <p>例如说：在 <a href="https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-system/src/main/java/cn/iocoder/yudao/module/system/service/tenant/TenantServiceImpl.java" target="_blank" rel="noopener noreferrer">TenantServiceImpl<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的 <code>#createTenant(...)</code> 方法，在创建完租户时，需要模拟该租户，进行用户和角色的创建。如下图所示：</p> <p><img src="/img/Saas%E5%A4%9A%E7%A7%9F%E6%88%B7/11.png" alt="TenantUtils 模拟租户"></p> <h3 id="_5-7-job【重要】"><a href="#_5-7-job%E3%80%90%E9%87%8D%E8%A6%81%E3%80%91" class="header-anchor">#</a> 5.7 Job【重要】</h3> <blockquote><p>实现可见 <a href="https://github.com/YunaiV/ruoyi-vue-pro/tree/master/yudao-framework/yudao-spring-boot-starter-biz-tenant/src/main/java/cn/iocoder/yudao/framework/tenant/core/job" target="_blank" rel="noopener noreferrer"><code>job</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 包。</p></blockquote> <p>声明 <a href="https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-biz-tenant/src/main/java/cn/iocoder/yudao/framework/tenant/core/job/TenantJob.java" target="_blank" rel="noopener noreferrer"><code>@TenantJob</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 注解在 Job 方法上，实现<strong>并行</strong>遍历每个租户，执行定时任务的逻辑。</p> <h3 id="_5-8-mq"><a href="#_5-8-mq" class="header-anchor">#</a> 5.8 MQ</h3> <blockquote><p>实现可见 <a href="https://github.com/YunaiV/ruoyi-vue-pro/tree/master/yudao-framework/yudao-spring-boot-starter-biz-tenant/src/main/java/cn/iocoder/yudao/framework/tenant/core/mq" target="_blank" rel="noopener noreferrer"><code>mq</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 包。</p></blockquote> <p>通过租户对 MQ 层面的封装，实现租户上下文，可以继续传递到 MQ 消费的逻辑中，避免丢失的问题。实现原理是：</p> <ul><li>发送消息时，MQ 会将租户上下文的租户编号，记录到 Message 消息头 <code>tenant-id</code> 上。</li> <li>消费消息时，MQ 会将 Message 消息头 <code>tenant-id</code>，设置到租户上下文的租户编号。</li></ul> <h3 id="_5-9-async"><a href="#_5-9-async" class="header-anchor">#</a> 5.9 Async</h3> <blockquote><p>实现可见 <a href="https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-framework/yudao-spring-boot-starter-job/src/main/java/cn/iocoder/yudao/framework/quartz/config/YudaoAsyncAutoConfiguration.java" target="_blank" rel="noopener noreferrer"><code>YudaoAsyncAutoConfiguration</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 类。</p></blockquote> <p>通过使用阿里开源的 <a href="https://github.com/alibaba/transmittable-thread-local" target="_blank" rel="noopener noreferrer">TransmittableThreadLocal<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 组件，实现 Spring Async 执行异步逻辑时，租户上下文可以继续传递，避免丢失的问题。</p> <h2 id="_6-租户独立域名"><a href="#_6-%E7%A7%9F%E6%88%B7%E7%8B%AC%E7%AB%8B%E5%9F%9F%E5%90%8D" class="header-anchor">#</a> 6. 租户独立域名</h2> <p>在我们使用 SaaS 云产品的时候，每个租户会拥有 <strong>独立的子域名</strong>，例如说：租户 A 对应 <code>a.iocoder.cn</code>，租户 B 对应 <code>b.iocoder.cn</code>。</p> <p>目前管理后台已经提供类似的能力，更多大家可以基于它去拓展。实现方式：</p> <ol><li>在 <code>system_tenant</code> 表里，有个 <code>website</code> 字段为该租户的独立域名，你可以填写你希望分配给它的子域名。</li> <li>在 Nginx 上做 <strong>泛域名解析</strong> 到你的前端项目，例如说 Nginx 的 <code>server_name</code> <code>*.iocoder.cn</code> 解析到 Vue3 管理后台。</li></ol> <p>这样用户在访问管理后台的登录界面，会自动根据当前访问域名的 <code>host</code>，向后端获得对应的 <code>tenant-id</code> 编号，后续请求都带上它！</p> <p>ps：商城 uniapp 暂时还没做，感兴趣可以 pull request 贡献下噢！</p> <h2 id="_7-租户切换"><a href="#_7-%E7%A7%9F%E6%88%B7%E5%88%87%E6%8D%A2" class="header-anchor">#</a> 7. 租户切换</h2> <p>① 拥有 <code>system:tenant:visit</code> 权限的用户，支持切换租户，从而查看和操作其它租户的数据。如下图所示：</p> <p><img src="/img/Saas%E5%A4%9A%E7%A7%9F%E6%88%B7/%E5%88%87%E6%8D%A2%E7%A7%9F%E6%88%B7.png" alt="切换租户"></p> <p><code>system:tenant:visit</code> 权限的分配，可以在角色管理时，分配 [系统管理 -&gt; 租户管理 -&gt; 租户切换] 权限。</p> <p>② 注意：如果你的 HTTP 接口是查询个人相关的信息，不能进行租户的切换，例如说：登录用户的个人信息等。此时，<code>yudao.tenant.ignore-urls</code> 配置项进行添加。</p> <div class="language-YAML extra-class"><pre class="language-yaml"><code><span class="token key atrule">yudao</span><span class="token punctuation">:</span>
  <span class="token key atrule">tenant</span><span class="token punctuation">:</span>
    <span class="token key atrule">ignore-urls</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /admin<span class="token punctuation">-</span>api/system/user/profile/<span class="token important">**</span>
      <span class="token punctuation">-</span> /admin<span class="token punctuation">-</span>api/system/auth/<span class="token important">**</span>
</code></pre></div><p>③ 如果你要拓展这块的实现，最好阅读如下代码：</p> <ul><li>前端：<a href="https://gitee.com/yudaocode/yudao-ui-admin-vue3/commit/c6898c0a99b00fb08863295d7fb1adb06cf66113" target="_blank" rel="noopener noreferrer">https://gitee.com/yudaocode/yudao-ui-admin-vue3/commit/c6898c0a99b00fb08863295d7fb1adb06cf66113<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Boot 后端：<a href="https://gitee.com/zhijiantianya/ruoyi-vue-pro/commit/59234e1eeade300a68adc8183d58f616c14e90f1" target="_blank" rel="noopener noreferrer">https://gitee.com/zhijiantianya/ruoyi-vue-pro/commit/59234e1eeade300a68adc8183d58f616c14e90f1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Cloud 后端：<a href="https://gitee.com/zhijiantianya/yudao-cloud/commit/a07963335549da0e49f13c98cb79adc11df1524b" target="_blank" rel="noopener noreferrer">https://gitee.com/zhijiantianya/yudao-cloud/commit/a07963335549da0e49f13c98cb79adc11df1524b<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>
    </div>
</body>
</html>